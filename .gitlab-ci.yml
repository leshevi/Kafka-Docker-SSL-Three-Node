stages:
  - certificates
  - create_certificates
  - deploy_certificates
  - ðŸš€play
  - deploy

image: alpine:latest

variables:
  KAFKA_CERTS_DIR: "./kafka-certs"
  RENEW_DAYS: 30
  KAFKA_SERVERS: "91.186.196.108 85.193.91.131 217.25.93.144"
  SERVER_NAMES: "kafka1 kafka2 kafka3"
  CURRENT_PASS: $PASSWORD_KEY

check_certificates:
  stage: certificates
  tags:
    - Docker
  before_script:
    - apk add --no-cache openssh-client openssl
    - eval $(ssh-agent -s)
    - echo "$SSH_ROOT_PRIVATE_KEY" | tr -d '\r' | ssh-add -
  script:
    - |
      FIRST_SERVER=$(echo $KAFKA_SERVERS | cut -d' ' -f1)
      CERT_PATH="~/kafka-cluster/certs/ca.crt"
      
      echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ Ð½Ð° $FIRST_SERVER..."
      
      # ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ ÑÐºÐ°Ñ‡Ð°Ñ‚ÑŒ CA ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
      if scp -o StrictHostKeyChecking=no ansible@$FIRST_SERVER:$CERT_PATH ./ca.crt.tmp 2>/dev/null; then
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð°Ñ‚Ñƒ Ð¸ÑÑ‚ÐµÑ‡ÐµÐ½Ð¸Ñ (Ð² ÑÐµÐºÑƒÐ½Ð´Ð°Ñ…)
        EXPIRY_DATE=$(openssl x509 -enddate -noout -in ./ca.crt.tmp | cut -d= -f2)
        EXPIRY_SECONDS=$(date -d "${EXPIRY_DATE% GMT}" +%s)
        NOW_SECONDS=$(date +%s)
        DIFF_DAYS=$(( ($EXPIRY_SECONDS - $NOW_SECONDS) / 86400 ))
        
        echo "Ð¡ÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ Ð¸ÑÑ‚ÐµÐºÐ°ÐµÑ‚ Ñ‡ÐµÑ€ÐµÐ· $DIFF_DAYS Ð´Ð½ÐµÐ¹ ($EXPIRY_DATE)"
        
        if [ "$DIFF_DAYS" -lt "$RENEW_DAYS" ]; then
          echo "Ð’ÐÐ˜ÐœÐÐÐ˜Ð•: Ð¡Ñ€Ð¾Ðº Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ Ð¸ÑÑ‚ÐµÐºÐ°ÐµÑ‚. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ RENEW_CERT=true"
          echo "RENEW_CERT=true" >> build.env
        else
          echo "Ð¡ÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ ÐµÑ‰Ðµ Ð²Ð°Ð»Ð¸Ð´ÐµÐ½."
          echo "RENEW_CERT=false" >> build.env
        fi
      else
        echo "Ð¡ÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ. Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð¿ÐµÑ€Ð²Ð¸Ñ‡Ð½Ð°Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ."
        echo "RENEW_CERT=true" >> build.env
      fi
    - cat build.env
  artifacts:
    reports:
      dotenv: build.env # ÐŸÐµÑ€ÐµÐ´Ð°ÐµÑ‚ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ RENEW_CERT Ð² ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑÑ‚Ð°Ð´Ð¸Ð¸

# 2. Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ (Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ ÐµÑÐ»Ð¸ RENEW_CERT=true)
generate_certificates:
  stage: create_certificates
  tags:
    - Docker
  needs: ["check_certificates"]
  script:
    - if [ "$RENEW_CERT" != "true" ]; then echo "Skipping generation..."; exit 0; fi
    - apk add --no-cache openssl openjdk17-jre-headless
    - mkdir -p $KAFKA_CERTS_DIR
    - |
      openssl req -x509 -new -newkey rsa:4096 -days 3650 -nodes \
        -keyout $KAFKA_CERTS_DIR/ca.key -out $KAFKA_CERTS_DIR/ca.crt \
        -subj "/CN=Kafka-CA"

      i=1
      for server_ip in $KAFKA_SERVERS; do
        server_name=$(echo $SERVER_NAMES | cut -d' ' -f$i)
        server_name=${server_name:-server$i}
        
        echo "Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð´Ð»Ñ $server_name ($server_ip)..."
        
        # Key & CSR
        openssl req -new -newkey rsa:4096 -nodes \
          -keyout "$KAFKA_CERTS_DIR/$server_name.key" \
          -out "$KAFKA_CERTS_DIR/$server_name.csr" \
          -subj "/CN=$server_name" \
          -addext "subjectAltName=DNS:$server_name,IP:$server_ip"

        # Sign with CA
        openssl x509 -req -in "$KAFKA_CERTS_DIR/$server_name.csr" -days 365 \
          -CA $KAFKA_CERTS_DIR/ca.crt -CAkey $KAFKA_CERTS_DIR/ca.key \
          -CAcreateserial -out "$KAFKA_CERTS_DIR/$server_name.crt" \
          -copy_extensions copy

        # JKS (Keystore)
        openssl pkcs12 -export -in "$KAFKA_CERTS_DIR/$server_name.crt" \
          -inkey "$KAFKA_CERTS_DIR/$server_name.key" \
          -out "$KAFKA_CERTS_DIR/$server_name.p12" \
          -name "$server_name" -passout "pass:$CURRENT_PASS"

        keytool -importkeystore -deststorepass "$CURRENT_PASS" -destkeystore "$KAFKA_CERTS_DIR/$server_name.server.keystore.jks" \
          -srckeystore "$KAFKA_CERTS_DIR/$server_name.p12" -srcstoretype PKCS12 -srcstorepass "$CURRENT_PASS"

        # Truststore
        keytool -import -alias CARoot -file $KAFKA_CERTS_DIR/ca.crt \
          -keystore "$KAFKA_CERTS_DIR/$server_name.server.truststore.jks" -storepass "$CURRENT_PASS" -noprompt
        
       
      cat > "$KAFKA_CERTS_DIR/$server_name.client.properties" << EOF
        security.protocol=SSL
        ssl.truststore.location=/etc/kafka/secrets/$server_name.server.truststore.jks
        ssl.truststore.password=$CURRENT_PASS
        ssl.keystore.location=/etc/kafka/secrets/$server_name.server.keystore.jks
        ssl.keystore.password=$CURRENT_PASS
        ssl.endpoint.identification.algorithm=
      EOF

        i=$((i + 1))
      done
  artifacts:
    paths:
      - $KAFKA_CERTS_DIR/
    expire_in: 1 week

# 3. Ð”ÐµÐ¿Ð»Ð¾Ð¹ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²
deploy_certificates:
  stage: deploy_certificates
  tags:
    - Docker
  when: manual
  needs: ["generate_certificates"]
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_ROOT_PRIVATE_KEY" | tr -d '\r' | ssh-add -
  script:
    - |
      i=1
      for server_ip in $KAFKA_SERVERS; do
        server_name=$(echo $SERVER_NAMES | cut -d' ' -f$i)
        echo "ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð½Ð° $server_ip ($server_name)..."
        
        ssh -o StrictHostKeyChecking=no ansible@$server_ip "mkdir -p ~/kafka-cluster/certs"
        
        scp -o StrictHostKeyChecking=no \
          $KAFKA_CERTS_DIR/$server_name.server.keystore.jks \
          $KAFKA_CERTS_DIR/$server_name.server.truststore.jks \
          $KAFKA_CERTS_DIR/$server_name.client.properties \
          $KAFKA_CERTS_DIR/ca.crt \
          ansible@$server_ip:~/kafka-cluster/certs/
        
        i=$((i+1))
      done

ðŸš€generate_inventory_roles_and_play:
  stage: ðŸš€play
  variables:
    ANSIBLE_FORCE_COLOR: "1"
    ANSIBLE_PYTHON_INTERPRETER: /usr/bin/python3
    ANSIBLE_REMOTE_TMP: /tmp
    ANSIBLE_STARATEGY: linear
    ANSIBLE_PIPELINING: 1
    ANSIBLE_TRANSPORT: ssh
    ANSIBLE_BECOME_METHOD: su
    ANSIBLE_BECOME_USER: root
    ANSIBLE_BECOME_ASKPASS: 'False'
    ANSIBLE_FORCE_HANDLER: 'True'
    ANSIBLE_STDOUT_CALLBACK: "ansible.builtin.default"
    ANSIBLE_ASK_PASS: 'False'
    ANSIBLE_NOCOWS: 1
    ANSIBLE_HOST_KEY_CHECKING: 'false'
    ANSIBLE_BECOME_EXE: 'sudo -p "Password: " su -'
    ANSIBLE_DEPRECATION_WARNINGS: 'False'
    ANSIBLE_TIMEOUT: 30
  tags:
    - Docker
  when: manual
  script:
    - apk add --no-cache openssh-client ansible git
    - eval $(ssh-agent -s)
    - echo "$SSH_ROOT_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - |
      cat > hosts.yml << EOF
      ---
      all:
        vars:
          ansible_user: ansible
      EOF
      echo "  hosts:" >> hosts.yml
      i=1
      for server_ip in $KAFKA_SERVERS; do
        server_name=$(echo $SERVER_NAMES | cut -d' ' -f$i)
        echo "    $server_name:" >> hosts.yml
        echo "      ansible_host: $server_ip" >> hosts.yml
        i=$((i+1))
      done

      echo "Generated hosts.yml:"
      cat hosts.yml
    - |
      if [ -f requirements1.yml ]; then
        echo "Installing roles from requirements1.yml..."
        ansible-galaxy install -r requirements1.yml --ignore-errors -p roles/ --force
      else
        echo "No requirements.yml found, creating example..."
        cat > requirements1.yml << EOF
        # roles from GitLab
        - src: 'https://oauth2:${ANSIBLE_TOKEN}@gitlab.com/ansible_playbooks7843206/docker.git'
          version: main
          name: docker
          scm: 'git'
        - src: 'https://oauth2:${ANSIBLE_TOKEN}@gitlab.com/ansible_playbooks7843206/hosts_create.git'
          version: main
          name: hosts
          scm: 'git'
      EOF

        ansible-galaxy install -r requirements1.yml -p roles/ --force
      fi

      echo "Installed roles:"
      ls -la roles/
    - rm requirements1.yml
    - ansible --version
    - ansible all -i hosts.yml -m ping
    - |
      echo "Current directory structure:"
      ls -la

      echo "Inventory file:"
      cat hosts.yml

      echo "Running playbook..."
      ansible-playbook -i hosts.yml playbook.yml --limit all
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH


# 4. Ð”ÐµÐ¿Ð»Ð¾Ð¹ ÐºÐ»Ð°ÑÑ‚ÐµÑ€Ð°
deploy-kafka-cluster:
  stage: deploy
  tags:
    - Docker
  when: manual
  before_script:
    - apk add --no-cache openssh-client docker-compose gettext
    - eval $(ssh-agent -s)
    - echo "$SSH_ROOT_PRIVATE_KEY" | tr -d '\r' | ssh-add -
  script:
    - |
      i=1
      for server_ip in $KAFKA_SERVERS; do
        server_name=$(echo $SERVER_NAMES | cut -d' ' -f$i)
        echo "ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð½Ð° $server_ip ($server_name)..."
        export KAFKA_NODE_ID=$i
        export NODE_IP=$server_ip
        export PASS_KEY=$PASSWORD_KEY
        export NAME_NODE=$server_name
        n=1
        for ip in $KAFKA_SERVERS; do
          echo "Ð Ð°Ð±Ð¾Ñ‚Ð°ÑŽ Ñ IP: $ip"
          echo -n $n@$ip:9093, >> file.txt
          n=$((n+1))
        done
        sed -i '$ s/,$//' file.txt
        export QUORUM=$(cat "file.txt")
        rm file.txt
        envsubst < docker-compose.templates.yml > docker-compose.yml
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸Ð½Ð´Ð¸Ð²Ð¸Ð´ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ compose
        sed "s/YOUR_SERVER_IP/$server_ip/g" docker-compose.yml > "docker-compose.$server_ip.yml"
        
        scp -o StrictHostKeyChecking=no "docker-compose.$server_ip.yml" ansible@$server_ip:~/kafka-cluster/docker-compose.yml
        
        ssh -o StrictHostKeyChecking=no ansible@$server_ip "cd ~/kafka-cluster && docker compose up -d"
        i=$((i+1))
      done
      ssh -o StrictHostKeyChecking=no ansible@$server_ip "cd ~/kafka-cluster && \
        docker compose exec -T kafka /opt/kafka/bin/kafka-metadata-quorum.sh \
        --bootstrap-server localhost:9092 \
        --command-config /etc/kafka/secrets/$server_name.client.properties \
        describe --status"
